[build]
builder = "NIXPACKS"
watchPatterns = ["backend/**"]

[deploy]
startCommand = "uvicorn main:app --host 0.0.0.0 --port $PORT"
restartPolicyType = "ON_FAILURE"
restartPolicyMaxRetries = 3

[env]
PORT = { default = "8000" }
ENVIRONMENT = { default = "production" }
BACKEND_API_KEY = { default = "polycraft_prod_secure_key_change_me" }
CORS_ORIGINS = { default = "https://poly-craft.vercel.app" }
RATE_LIMIT_IMAGE = { default = "15" }
RATE_LIMIT_TEXT = { default = "30" }
RATE_LIMIT_AUDIO = { default = "10" }
RATE_LIMIT_BATCH = { default = "5" }
RATE_LIMIT_GLOBAL = { default = "100" }
CACHE_TTL_IMAGE = { default = "3600" }
CACHE_TTL_TEXT = { default = "1800" }
CACHE_TTL_AUDIO = { default = "3600" }
MAX_CONCURRENT_REQUESTS = { default = "10" }
REQUEST_TIMEOUT = { default = "30" }
KEEPALIVE_TIMEOUT = { default = "5" }
SECURE_HEADERS = { default = "true" }
HTTPS_ONLY = { default = "true" }

[healthcheck]
path = "/health"
interval = 30
timeout = 10
retries = 3

[regions]
default = "us-west1"

[scaling]
autoscale = false
minReplicas = 1
maxReplicas = 3

[resources]
cpu = 0.5
memory = 512